"use client";

import { Fragment, Suspense } from "react";
import { formatDistanceToNow } from "date-fns";
import {
  FileText,
  MessageSquare,
  Wrench,
  Server,
  ExternalLink,
  Shield,
  Activity,
  AlertTriangle,
  ExternalLinkIcon,
  Computer,
  BugIcon,
} from "lucide-react";

import {
  Drawer,
  DrawerClose,
  DrawerContent,
  DrawerDescription,
  DrawerHeader,
  DrawerTitle,
  DrawerTrigger,
} from "@/components/ui/drawer";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  ResizableHandle,
  ResizablePanel,
  ResizablePanelGroup,
} from "@/components/ui/resizable";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Separator } from "@/components/ui/separator";
import { cn, plural } from "@/lib/utils";
import { VulnerabilityWithRelations } from "../server/routers";
import { useIsMobile } from "@/hooks/use-mobile";
import { CopyCode } from "@/components/ui/code";
import { IssuesSidebarList } from "@/features/issues/components/issue";
import { Skeleton } from "@/components/ui/skeleton";
import { QuestionTooltip } from "@/components/ui/question-tooltip";

// ============================================================================
// Types
// ============================================================================

interface VulnerabilityDrawerProps {
  vulnerability: VulnerabilityWithRelations;
  open: boolean;
  setOpen: (open: boolean) => void;
  children?: React.ReactNode;
}

// ============================================================================
// Details Section
// ============================================================================

function DetailsSection({
  vulnerability,
}: {
  vulnerability: VulnerabilityWithRelations;
}) {
  const sections = [
    {
      header: "Description",
      content: vulnerability.description || "No description available",
    },
    ...(vulnerability.narrative
      ? [
          {
            header: "Narrative",
            content: vulnerability.narrative,
          },
        ]
      : []),
    ...(vulnerability.impact
      ? [
          {
            header: "Clinical Impact",
            content: vulnerability.impact,
          },
        ]
      : []),
  ];

  return (
    <div className="space-y-6">
      {sections.map((section, i) => (
        <Fragment key={`details${i}`}>
          {i > 0 && <Separator />}
          <div>
            <h3 className="text-sm font-medium text-muted-foreground mb-2">
              {section.header}
            </h3>
            <p className="text-sm leading-relaxed">{section.content}</p>
          </div>
        </Fragment>
      ))}
    </div>
  );
}

// ============================================================================
// AI Chat Section
// ============================================================================

// TODO: this will have to be expanded later ofc, if we commit to this design
function AIChatSection() {
  return (
    <div className="flex items-center justify-center h-full text-muted-foreground">
      <div className="text-center space-y-2">
        <MessageSquare className="h-12 w-12 mx-auto opacity-50" />
        <p className="text-sm">AI Chat coming soon</p>
      </div>
    </div>
  );
}

// ============================================================================
// Remediations Section
// ============================================================================

// TODO: this doesn't look great, will have to be expanded with useful fields if we commit to the design
function RemediationsSection({
  vulnerability,
}: {
  vulnerability: VulnerabilityWithRelations;
}) {
  const remediations = vulnerability.remediations;

  if (remediations.length === 0) {
    return (
      <div className="flex items-center justify-center h-full text-muted-foreground">
        <div className="text-center space-y-2">
          <Wrench className="h-12 w-12 mx-auto opacity-50" />
          <p className="text-sm">No remediations available</p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {remediations.map((remediation) => (
        <Card key={remediation.id}>
          <CardHeader>
            <div className="flex items-start justify-between">
              <CardTitle className="text-base font-medium">
                Remediation {remediation.id}
              </CardTitle>
              <Badge variant="outline">
                {remediation._count.artifacts}{" "}
                {plural("Artifact", remediation._count.artifacts)}
              </Badge>
            </div>
          </CardHeader>
          <CardContent className="space-y-2">
            {remediation.description && (
              <p className="text-sm text-muted-foreground">
                {remediation.description}
              </p>
            )}
            <div className="flex items-center gap-1 text-xs text-muted-foreground">
              <span>By {remediation.user.name}</span>
              <span>â€¢</span>
              <span>
                {formatDistanceToNow(remediation.createdAt, {
                  addSuffix: true,
                })}
              </span>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}

// ============================================================================
// Affected Assets Section
// ============================================================================

function AffectedAssetsSection({
  vulnerability,
}: {
  vulnerability: VulnerabilityWithRelations;
}) {
  const issues = vulnerability.issues;

  if (issues.length === 0) {
    return (
      <div className="flex items-center justify-center h-full text-muted-foreground">
        <div className="text-center space-y-2">
          <Computer className="h-12 w-12 mx-auto opacity-50" />
          <p className="text-sm">No affected assets</p>
        </div>
      </div>
    );
  }

  return (
    <Suspense fallback={<Skeleton className="h-16 w-full" />}>
      <IssuesSidebarList issues={issues} type="assets" />
    </Suspense>
  );
}

// ============================================================================
// Second Column / Static Info
// ============================================================================
function VulnerabilityInfoColumn({
  vulnerability,
}: {
  vulnerability: VulnerabilityWithRelations;
}) {
  // TODO: this is an initial way to calculate risk score, should probably be changed/thought more about later
  const riskScore =
    (vulnerability.cvssScore || 0) *
    (vulnerability.epss || 0) *
    (vulnerability.inKEV ? 1.5 : 1.0) *
    vulnerability._count.issues;

  const sections = [
    {
      header: "Risk Metrics",
      items: [
        {
          header: "Combined Risk Score",
          content: (
            <div className="text-sm flex gap-1 items-center">
              <span>{riskScore.toFixed(2)}</span>
              <QuestionTooltip>
                CVSS x EPSS x number of affected assets. 1.5x multiplier if in
                KEV.
              </QuestionTooltip>
            </div>
          ),
        },
        {
          header: "EPSS Score",
          content: (
            <div className="text-sm">
              {vulnerability.epss
                ? `${(vulnerability.epss * 100).toFixed(1)}%`
                : "N/A"}
            </div>
          ),
        },
        {
          header: "CVSS Score",
          content: (
            <div className="text-sm">
              {vulnerability.cvssScore?.toFixed(1) || "N/A"}
            </div>
          ),
        },
        {
          header: "In KEV Catalog?",
          content: (
            <div className="flex items-center gap-2">
              <Badge variant={vulnerability.inKEV ? "destructive" : "outline"}>
                {vulnerability.inKEV ? "Yes" : "No"}
              </Badge>
              {vulnerability.inKEV && vulnerability.updatedInKev && (
                <span className="text-xs text-muted-foreground">
                  Added{" "}
                  {formatDistanceToNow(vulnerability.updatedInKev, {
                    addSuffix: true,
                  })}
                </span>
              )}
            </div>
          ),
        },
      ],
    },
    {
      header: "Metadata",
      items: [
        {
          header: "Created",
          content: (
            <div className="text-sm">
              {formatDistanceToNow(vulnerability.createdAt, {
                addSuffix: true,
              })}{" "}
              ({new Date(vulnerability.createdAt).toLocaleString()})
            </div>
          ),
        },
        {
          header: "Last Updated",
          content: (
            <div className="text-sm">
              {formatDistanceToNow(vulnerability.updatedAt, {
                addSuffix: true,
              })}{" "}
              ({new Date(vulnerability.updatedAt).toLocaleString()})
            </div>
          ),
        },
        {
          header: "Vulnerability ID",
          content: <CopyCode>{vulnerability.id}</CopyCode>,
        },
      ],
    },
    {
      header: "Technical Details",
      items: [
        {
          header: "CPE Identifiers",
          content: (
            <ul>
              {vulnerability.affectedDeviceGroups.map((group) => (
                <li key={group.cpe}>
                  <CopyCode>{group.cpe}</CopyCode>
                </li>
              ))}
            </ul>
          ),
        },
        ...(vulnerability.exploitUri
          ? [
              {
                header: "Exploit Repository",
                content: (
                  <a
                    href={vulnerability.exploitUri ?? undefined}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs text-primary hover:underline flex items-center gap-1"
                  >
                    {vulnerability.exploitUri}
                    <ExternalLinkIcon className="size-3" />
                  </a>
                ),
              },
            ]
          : []),
        ...(vulnerability.upstreamApi
          ? [
              {
                header: "Upstream API",
                content: (
                  <a
                    href={vulnerability.upstreamApi ?? undefined}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs text-primary hover:underline flex items-center gap-1"
                  >
                    {vulnerability.upstreamApi}
                    <ExternalLinkIcon className="size-3" />
                  </a>
                ),
              },
            ]
          : []),
      ],
    },
    {
      header: "SARIF Data",
      items: [
        {
          header: "SARIF",
          content: (
            <pre className="text-xs bg-muted p-3 rounded overflow-x-auto max-w-md">
              {JSON.stringify(vulnerability.sarif, null, 2)}
            </pre>
          ),
        },
      ],
    },
  ];

  return (
    <ScrollArea className="h-full">
      <div className="flex flex-col gap-6 overflow-y-auto p-4 text-sm">
        {sections.map((section, i) => (
          <Fragment key={section.header}>
            {i > 0 && <Separator />}
            <div className="flex flex-col gap-3">
              <h3 className="font-semibold sticky top-0">{section.header}</h3>
              <div className="grid grid-cols-1 gap-3">
                {section.items.map(({ header, content }) => (
                  <div key={header}>
                    <div className="text-xs font-medium text-muted-foreground mb-1">
                      {header}
                    </div>
                    {content}
                  </div>
                ))}
              </div>
            </div>
          </Fragment>
        ))}
      </div>
    </ScrollArea>
  );
}

// ============================================================================
// Main Drawer Component
// ============================================================================

export function PrioritizedVulnerabilityDrawer({
  vulnerability,
  open,
  setOpen,
  children,
}: VulnerabilityDrawerProps) {
  const isMobile = useIsMobile();
  const tabs = [
    {
      value: "details",
      label: "Details",
      icon: FileText,
      content: <DetailsSection vulnerability={vulnerability} />,
    },
    {
      value: "chat",
      label: "AI Chat",
      icon: MessageSquare,
      content: <AIChatSection />,
    },
    {
      value: "remediations",
      label: "Remediations",
      icon: Wrench,
      count: vulnerability.remediations.length,
      content: <RemediationsSection vulnerability={vulnerability} />,
    },
    {
      value: "assets",
      label: "Affected Assets",
      icon: Computer,
      count: vulnerability.issues.length,
      content: <AffectedAssetsSection vulnerability={vulnerability} />,
    },
  ];

  return (
    <Drawer
      direction={isMobile ? "bottom" : "right"}
      open={open}
      onOpenChange={setOpen}
    >
      {children && <DrawerTrigger asChild>{children}</DrawerTrigger>}
      <DrawerContent className={isMobile ? "max-w-lg" : "max-w-[70%]!"}>
        <DrawerHeader className="border-b">
          <div className="flex items-center justify-between">
            <div className="space-y-1">
              <DrawerTitle className="text-xl">
                {vulnerability.cveId ||
                  `Vulnerability ${vulnerability.id.slice(0, 8)}`}
              </DrawerTitle>
              <DrawerDescription className="flex items-center gap-2">
                <Badge variant="outline" className="text-primary">
                  <BugIcon className="size-3 mr-1" />
                  Vulnerability
                </Badge>
                <Badge
                  variant={
                    vulnerability.severity === "Critical"
                      ? "destructive"
                      : vulnerability.severity === "High"
                        ? "destructive"
                        : vulnerability.severity === "Medium"
                          ? "default"
                          : "secondary"
                  }
                >
                  {vulnerability.severity}
                </Badge>
                {vulnerability.cvssScore && (
                  <span className="text-sm">
                    Updated{" "}
                    {formatDistanceToNow(vulnerability.updatedAt, {
                      addSuffix: true,
                    })}
                  </span>
                )}
              </DrawerDescription>
            </div>
            <DrawerClose asChild>
              <Button variant="outline">Close</Button>
            </DrawerClose>
          </div>
        </DrawerHeader>

        <ResizablePanelGroup direction="horizontal" className="flex-1">
          {/* Left Panel - Navigation + Content */}
          <ResizablePanel defaultSize={60} minSize={30}>
            <Tabs defaultValue="details" className="flex flex-col h-full">
              <TabsList className="w-full justify-start rounded-none border-b bg-muted">
                {tabs.map((tab) => {
                  const Icon = tab.icon;
                  return (
                    <TabsTrigger
                      key={tab.value}
                      value={tab.value}
                      className="gap-2"
                    >
                      <Icon className="h-4 w-4" />
                      {tab.label}
                      {tab.count !== undefined && (
                        <Badge variant="secondary">{tab.count}</Badge>
                      )}
                    </TabsTrigger>
                  );
                })}
              </TabsList>

              {tabs.map((tab) => (
                <TabsContent
                  key={tab.value}
                  value={tab.value}
                  className="flex-1 m-0"
                >
                  <ScrollArea className="h-full">
                    <div className="p-6">{tab.content}</div>
                  </ScrollArea>
                </TabsContent>
              ))}
            </Tabs>
          </ResizablePanel>

          <ResizableHandle withHandle />

          {/* Right Panel - Static Info */}
          <ResizablePanel defaultSize={40} minSize={25}>
            <VulnerabilityInfoColumn vulnerability={vulnerability} />
          </ResizablePanel>
        </ResizablePanelGroup>
      </DrawerContent>
    </Drawer>
  );
}
