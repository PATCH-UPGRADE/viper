"use client";

import { formatDistanceToNow } from "date-fns";
import {
  BugIcon,
  Computer,
  ExternalLinkIcon,
  FileText,
  MessageSquare,
  Wrench,
} from "lucide-react";
import { Fragment, Suspense } from "react";
import {
  AIChatSection,
  DashboardDrawerShell,
  InfoColumn,
  type InfoColumnSection,
} from "@/components/dashboard-drawers";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { CopyCode } from "@/components/ui/code";
import { QuestionTooltip } from "@/components/ui/question-tooltip";
import { Separator } from "@/components/ui/separator";
import { Skeleton } from "@/components/ui/skeleton";
import { IssuesSidebarList } from "@/features/issues/components/issue";
import { plural } from "@/lib/utils";
import type { VulnerabilityWithRelations } from "../types";

// ============================================================================
// Types
// ============================================================================

interface VulnerabilityDrawerProps {
  vulnerability: VulnerabilityWithRelations;
  open: boolean;
  setOpen: (open: boolean) => void;
  children?: React.ReactNode;
}

// ============================================================================
// Details Section
// ============================================================================

function DetailsSection({
  vulnerability,
}: {
  vulnerability: VulnerabilityWithRelations;
}) {
  const sections = [
    {
      header: "Description",
      content: vulnerability.description || "No description available",
    },
    ...(vulnerability.narrative
      ? [
          {
            header: "Narrative",
            content: vulnerability.narrative,
          },
        ]
      : []),
    ...(vulnerability.impact
      ? [
          {
            header: "Clinical Impact",
            content: vulnerability.impact,
          },
        ]
      : []),
  ];

  return (
    <div className="space-y-6">
      {sections.map((section, i) => (
        <Fragment key={`details${i}`}>
          {i > 0 && <Separator />}
          <div>
            <h3 className="text-sm font-medium text-muted-foreground mb-2">
              {section.header}
            </h3>
            <p className="text-sm leading-relaxed">{section.content}</p>
          </div>
        </Fragment>
      ))}
    </div>
  );
}

// ============================================================================
// Remediations Section
// ============================================================================

// TODO: this doesn't look great, will have to be expanded with useful fields if we commit to the design
function RemediationsSection({
  vulnerability,
}: {
  vulnerability: VulnerabilityWithRelations;
}) {
  const remediations = vulnerability.remediations;

  if (remediations.length === 0) {
    return (
      <div className="flex items-center justify-center h-full text-muted-foreground">
        <div className="text-center space-y-2">
          <Wrench className="h-12 w-12 mx-auto opacity-50" />
          <p className="text-sm">No remediations available</p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {remediations.map((remediation) => (
        <Card key={remediation.id}>
          <CardHeader>
            <div className="flex items-start justify-between">
              <CardTitle className="text-base font-medium">
                Remediation {remediation.id}
              </CardTitle>
              <Badge variant="outline">
                {remediation._count.artifacts}{" "}
                {plural("Artifact", remediation._count.artifacts)}
              </Badge>
            </div>
          </CardHeader>
          <CardContent className="space-y-2">
            {remediation.description && (
              <p className="text-sm text-muted-foreground">
                {remediation.description}
              </p>
            )}
            <div className="flex items-center gap-1 text-xs text-muted-foreground">
              <span>By {remediation.user.name}</span>
              <span>â€¢</span>
              <span>
                {formatDistanceToNow(remediation.createdAt, {
                  addSuffix: true,
                })}
              </span>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}

// ============================================================================
// Affected Assets Section
// ============================================================================

function AffectedAssetsSection({
  vulnerability,
}: {
  vulnerability: VulnerabilityWithRelations;
}) {
  const issues = vulnerability.issues;

  if (issues.length === 0) {
    return (
      <div className="flex items-center justify-center h-full text-muted-foreground">
        <div className="text-center space-y-2">
          <Computer className="h-12 w-12 mx-auto opacity-50" />
          <p className="text-sm">No affected assets</p>
        </div>
      </div>
    );
  }

  return (
    <Suspense fallback={<Skeleton className="h-16 w-full" />}>
      <IssuesSidebarList issues={issues} type="assets" />
    </Suspense>
  );
}

// ============================================================================
// Info Column Sections
// ============================================================================

function VulnerabilityInfoColumn({
  vulnerability,
}: {
  vulnerability: VulnerabilityWithRelations;
}) {
  // TODO: this is an initial way to calculate risk score, should probably be changed/thought more about later
  const riskScore =
    (vulnerability.cvssScore || 1) *
    (vulnerability.epss || 0) *
    (vulnerability.inKEV ? 1.5 : 1.0) *
    Math.max(vulnerability._count.issues, 1);

  const sections: InfoColumnSection[] = [
    {
      header: "Risk Metrics",
      items: [
        {
          header: "Combined Risk Score",
          content: (
            <div className="text-sm flex gap-1 items-center">
              <span>{riskScore.toFixed(2)}</span>
              <QuestionTooltip>
                CVSS x EPSS x number of affected assets. 1.5x multiplier if in
                KEV.
              </QuestionTooltip>
            </div>
          ),
        },
        {
          header: "EPSS Score",
          content: (
            <div className="text-sm">
              {vulnerability.epss
                ? `${(vulnerability.epss * 100).toFixed(1)}%`
                : "N/A"}
            </div>
          ),
        },
        {
          header: "CVSS Score",
          content: (
            <div className="text-sm">
              {vulnerability.cvssScore?.toFixed(1) || "N/A"}
            </div>
          ),
        },
        {
          header: "In KEV Catalog?",
          content: (
            <div className="flex items-center gap-2">
              <Badge variant={vulnerability.inKEV ? "destructive" : "outline"}>
                {vulnerability.inKEV ? "Yes" : "No"}
              </Badge>
              {vulnerability.inKEV && vulnerability.updatedInKev && (
                <span className="text-xs text-muted-foreground">
                  Added{" "}
                  {formatDistanceToNow(vulnerability.updatedInKev, {
                    addSuffix: true,
                  })}
                </span>
              )}
            </div>
          ),
        },
      ],
    },
    {
      header: "Metadata",
      items: [
        {
          header: "Created",
          content: (
            <div className="text-sm">
              {formatDistanceToNow(vulnerability.createdAt, {
                addSuffix: true,
              })}{" "}
              ({new Date(vulnerability.createdAt).toLocaleString()})
            </div>
          ),
        },
        {
          header: "Last Updated",
          content: (
            <div className="text-sm">
              {formatDistanceToNow(vulnerability.updatedAt, {
                addSuffix: true,
              })}{" "}
              ({new Date(vulnerability.updatedAt).toLocaleString()})
            </div>
          ),
        },
        {
          header: "Vulnerability ID",
          content: <CopyCode>{vulnerability.id}</CopyCode>,
        },
      ],
    },
    {
      header: "Technical Details",
      items: [
        {
          header: "CPE Identifiers",
          content: (
            <ul>
              {vulnerability.affectedDeviceGroups.map((group) => (
                <li key={group.cpe}>
                  <CopyCode>{group.cpe}</CopyCode>
                </li>
              ))}
            </ul>
          ),
        },
        ...(vulnerability.exploitUri
          ? [
              {
                header: "Exploit Repository",
                content: (
                  <a
                    href={vulnerability.exploitUri ?? undefined}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs text-primary hover:underline flex items-center gap-1"
                  >
                    {vulnerability.exploitUri}
                    <ExternalLinkIcon className="size-3" />
                  </a>
                ),
              },
            ]
          : []),
        ...(vulnerability.upstreamApi
          ? [
              {
                header: "Upstream API",
                content: (
                  <a
                    href={vulnerability.upstreamApi ?? undefined}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-xs text-primary hover:underline flex items-center gap-1"
                  >
                    {vulnerability.upstreamApi}
                    <ExternalLinkIcon className="size-3" />
                  </a>
                ),
              },
            ]
          : []),
      ],
    },
    {
      header: "SARIF Data",
      items: [
        {
          header: "SARIF",
          content: (
            <pre className="text-xs bg-muted p-3 rounded overflow-x-auto max-w-md">
              {JSON.stringify(vulnerability.sarif, null, 2)}
            </pre>
          ),
        },
      ],
    },
  ];

  return <InfoColumn sections={sections} />;
}

// ============================================================================
// Main Drawer Component
// ============================================================================

export function PrioritizedVulnerabilityDrawer({
  vulnerability,
  open,
  setOpen,
  children,
}: VulnerabilityDrawerProps) {
  const tabs = [
    {
      value: "details",
      label: "Details",
      icon: FileText,
      content: <DetailsSection vulnerability={vulnerability} />,
    },
    {
      value: "chat",
      label: "AI Chat",
      icon: MessageSquare,
      content: <AIChatSection />,
    },
    {
      value: "remediations",
      label: "Remediations",
      icon: Wrench,
      count: vulnerability.remediations.length,
      content: <RemediationsSection vulnerability={vulnerability} />,
    },
    {
      value: "assets",
      label: "Affected Assets",
      icon: Computer,
      count: vulnerability.issues.length,
      content: <AffectedAssetsSection vulnerability={vulnerability} />,
    },
  ];

  const description = (
    <>
      <Badge variant="outline" className="text-primary">
        <BugIcon className="size-3 mr-1" />
        Vulnerability
      </Badge>
      <Badge
        variant={
          vulnerability.priority === "Critical" ||
          vulnerability.priority === "High"
            ? "destructive"
            : vulnerability.priority === "Monitor"
              ? "default"
              : "secondary"
        }
      >
        {vulnerability.priority}
      </Badge>
      <span className="text-sm">
        Updated{" "}
        {formatDistanceToNow(vulnerability.updatedAt, {
          addSuffix: true,
        })}
      </span>
    </>
  );

  return (
    <DashboardDrawerShell
      open={open}
      setOpen={setOpen}
      title={
        vulnerability.cveId ||
        `Vulnerability ${vulnerability.id.slice(0, 8)}`
      }
      description={description}
      tabs={tabs}
      infoColumn={<VulnerabilityInfoColumn vulnerability={vulnerability} />}
    >
      {children}
    </DashboardDrawerShell>
  );
}
