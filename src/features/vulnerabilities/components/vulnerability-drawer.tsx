"use client";

import { Suspense } from "react";
import { formatDistanceToNow } from "date-fns";
import {
  FileText,
  MessageSquare,
  Wrench,
  Server,
  ExternalLink,
  Shield,
  Activity,
  AlertTriangle,
  ExternalLinkIcon,
  Computer,
} from "lucide-react";

import {
  Drawer,
  DrawerContent,
  DrawerDescription,
  DrawerHeader,
  DrawerTitle,
  DrawerTrigger,
} from "@/components/ui/drawer";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  ResizableHandle,
  ResizablePanel,
  ResizablePanelGroup,
} from "@/components/ui/resizable";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Separator } from "@/components/ui/separator";
import { cn } from "@/lib/utils";
import { VulnerabilityWithRelations } from "../server/routers";
import { useIsMobile } from "@/hooks/use-mobile";
import { CopyCode } from "@/components/ui/code";
import { IssuesSidebarList } from "@/features/issues/components/issue";
import { Skeleton } from "@/components/ui/skeleton";

// ============================================================================
// Types
// ============================================================================

interface VulnerabilityDrawerProps {
  vulnerability: VulnerabilityWithRelations;
  open: boolean;
  setOpen: (open: boolean) => void;
  children?: React.ReactNode;
}

// ============================================================================
// Details Section
// ============================================================================

function DetailsSection({
  vulnerability,
}: {
  vulnerability: VulnerabilityWithRelations;
}) {
  return (
    <div className="space-y-6">
      <div>
        <h3 className="text-sm font-medium text-muted-foreground mb-2">
          Description
        </h3>
        <p className="text-sm leading-relaxed">
          {vulnerability.description || "No description available"}
        </p>
      </div>

      {vulnerability.narrative && (
        <>
          <Separator />
          <div>
            <h3 className="text-sm font-medium text-muted-foreground mb-2">
              Exploit Narrative
            </h3>
            <p className="text-sm leading-relaxed">{vulnerability.narrative}</p>
          </div>
        </>
      )}

      {vulnerability.impact && (
        <>
          <Separator />
          <div>
            <h3 className="text-sm font-medium text-muted-foreground mb-2">
              Clinical Impact
            </h3>
            <p className="text-sm leading-relaxed">{vulnerability.impact}</p>
          </div>
        </>
      )}
    </div>
  );
}

// ============================================================================
// AI Chat Section
// ============================================================================

function AIChatSection() {
  return (
    <div className="flex items-center justify-center h-full text-muted-foreground">
      <div className="text-center space-y-2">
        <MessageSquare className="h-12 w-12 mx-auto opacity-50" />
        <p className="text-sm">AI Chat integration coming soon</p>
      </div>
    </div>
  );
}

// ============================================================================
// Remediations Section
// ============================================================================

function RemediationsSection({
  vulnerability,
}: {
  vulnerability: VulnerabilityWithRelations;
}) {
  const remediations = vulnerability.remediations;

  if (remediations.length === 0) {
    return (
      <div className="flex items-center justify-center h-full text-muted-foreground">
        <div className="text-center space-y-2">
          <Wrench className="h-12 w-12 mx-auto opacity-50" />
          <p className="text-sm">No remediations available</p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {remediations.map((remediation) => (
        <Card key={remediation.id}>
          <CardHeader className="pb-3">
            <div className="flex items-start justify-between">
              <CardTitle className="text-base font-medium">
                Remediation {remediation.id.slice(0, 8)}
              </CardTitle>
              <Badge variant="outline">
                {remediation._count.artifacts} Artifact
                {remediation._count.artifacts !== 1 ? "s" : ""}
              </Badge>
            </div>
          </CardHeader>
          <CardContent className="space-y-2">
            {remediation.description && (
              <p className="text-sm text-muted-foreground">
                {remediation.description}
              </p>
            )}
            <div className="flex items-center gap-4 text-xs text-muted-foreground">
              <span>By {remediation.user.name}</span>
              <span>â€¢</span>
              <span>
                {formatDistanceToNow(remediation.createdAt, {
                  addSuffix: true,
                })}
              </span>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}

// ============================================================================
// Affected Assets Section
// ============================================================================

function AffectedAssetsSection({
  vulnerability,
}: {
  vulnerability: VulnerabilityWithRelations;
}) {
  const issues = vulnerability.issues;

  if (issues.length === 0) {
    return (
      <div className="flex items-center justify-center h-full text-muted-foreground">
        <div className="text-center space-y-2">
          <Computer className="h-12 w-12 mx-auto opacity-50" />
          <p className="text-sm">No affected assets</p>
        </div>
      </div>
    );
  }

  return (
    <Suspense fallback={<Skeleton className="h-16 w-full" />}>
                <IssuesSidebarList
                  issues={issues}
                  type="assets"
                />
              </Suspense>
  );
}

// ============================================================================
// Second Column (Static Info)
// ============================================================================
function VulnerabilityInfoColumn({
  vulnerability,
}: {
  vulnerability: VulnerabilityWithRelations;
}) {
  const riskScore =
    (vulnerability.cvssScore || 0) *
    (vulnerability.epss || 0) *
    (vulnerability.inKEV ? 1.5 : 1.0) * (vulnerability._count.issues);

  return (
    <ScrollArea className="h-full">
      <div className="flex flex-col gap-6 overflow-y-auto p-4 text-sm">
        {/* Risk Metrics */}
        <div className="flex flex-col gap-3">
          <h3 className="font-semibold">Risk Metrics</h3>

          <div className="grid grid-cols-1 gap-3">
            <div>
              <div className="text-xs font-medium text-muted-foreground mb-1">
                Combined Risk Score
              </div>
              <div className="text-sm">{riskScore.toFixed(2)}</div>
            </div>

            <div>
              <div className="text-xs font-medium text-muted-foreground mb-1">
                EPSS Score
              </div>
              <div className="text-sm">
                {vulnerability.epss
                  ? `${(vulnerability.epss * 100).toFixed(1)}%`
                  : "N/A"}
              </div>
            </div>

            <div>
              <div className="text-xs font-medium text-muted-foreground mb-1">
                CVSS Score
              </div>
              <div className="text-sm">
                {vulnerability.cvssScore?.toFixed(1) || "N/A"}
              </div>
            </div>

            <div>
              <div className="text-xs font-medium text-muted-foreground mb-1">
                In KEV Catalog?
              </div>
              <div className="flex items-center gap-2">
                <Badge
                  variant={vulnerability.inKEV ? "destructive" : "outline"}
                >
                  {vulnerability.inKEV ? "Yes" : "No"}
                </Badge>
                {vulnerability.inKEV && vulnerability.updatedInKev && (
                  <span className="text-xs text-muted-foreground">
                    Added{" "}
                    {formatDistanceToNow(vulnerability.updatedInKev, {
                      addSuffix: true,
                    })}
                  </span>
                )}
              </div>
            </div>
          </div>
        </div>

        <Separator />

        {/* Technical Details */}
        <div className="flex flex-col gap-3">
          <h3 className="font-semibold">Technical Details</h3>

          <div className="grid grid-cols-1 gap-3">
            <div>
              <div className="text-xs font-medium text-muted-foreground mb-1">
                CPE Identifiers
              </div>
              <ul>
                {vulnerability.affectedDeviceGroups.map((group) => (
                  <li key={group.cpe}>
                    <CopyCode>{group.cpe}</CopyCode>
                  </li>
                ))}
              </ul>
            </div>

            {vulnerability.exploitUri && (
              <div>
                <div className="text-xs font-medium text-muted-foreground mb-1">
                  Exploit Repository
                </div>
                <a
                  href={vulnerability.exploitUri ?? undefined}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-xs text-primary hover:underline flex items-center gap-1"
                >
                  {vulnerability.exploitUri}
                  <ExternalLinkIcon className="size-3" />
                </a>
              </div>
            )}

            {vulnerability.upstreamApi && (
              <div>
                <div className="text-xs font-medium text-muted-foreground mb-1">
                  Upstream API
                </div>
                <a
                  href={vulnerability.upstreamApi ?? undefined}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-xs text-primary hover:underline flex items-center gap-1"
                >
                  {vulnerability.upstreamApi}
                  <ExternalLinkIcon className="size-3" />
                </a>
              </div>
            )}
          </div>
        </div>

        <Separator />

        {/* SARIF Data */}
        <div className="flex flex-col gap-2">
          <h3 className="font-semibold">SARIF Data</h3>
          <pre className="text-xs bg-muted p-3 rounded overflow-x-auto max-w-md">
            {JSON.stringify(vulnerability.sarif, null, 2)}
          </pre>
        </div>
      </div>
    </ScrollArea>
  );
}

// ============================================================================
// Main Drawer Component
// ============================================================================

export function PrioritizedVulnerabilityDrawer({
  vulnerability,
  open,
  setOpen,
  children,
}: VulnerabilityDrawerProps) {
  const isMobile = useIsMobile();
  const tabs = [
    {
      value: "details",
      label: "Details",
      icon: FileText,
      content: <DetailsSection vulnerability={vulnerability} />,
    },
    {
      value: "chat",
      label: "AI Chat",
      icon: MessageSquare,
      content: <AIChatSection />,
    },
    {
      value: "remediations",
      label: "Remediations",
      icon: Wrench,
      count: vulnerability.remediations.length,
      content: <RemediationsSection vulnerability={vulnerability} />,
    },
    {
      value: "assets",
      label: "Affected Assets",
      icon: Computer,
      count: vulnerability.issues.length,
      content: <AffectedAssetsSection vulnerability={vulnerability} />,
    },
  ];

  return (
    <Drawer
      direction={isMobile ? "bottom" : "right"}
      open={open}
      onOpenChange={setOpen}
    >
      {children && <DrawerTrigger asChild>{children}</DrawerTrigger>}
      <DrawerContent className={isMobile ? "max-w-lg" : "max-w-[70%]!"}>
        <DrawerHeader className="border-b">
          <div className="flex items-start justify-between">
            <div className="space-y-1">
              <DrawerTitle className="text-xl">
                {vulnerability.cveId ||
                  `Vulnerability ${vulnerability.id.slice(0, 8)}`}
              </DrawerTitle>
              <DrawerDescription className="flex items-center gap-2">
                <Badge
                  variant={
                    vulnerability.severity === "Critical"
                      ? "destructive"
                      : vulnerability.severity === "High"
                        ? "destructive"
                        : vulnerability.severity === "Medium"
                          ? "default"
                          : "secondary"
                  }
                >
                  {vulnerability.severity}
                </Badge>
                {vulnerability.cvssScore && (
                  <span className="text-sm">
                    CVSS {vulnerability.cvssScore.toFixed(1)}
                  </span>
                )}
              </DrawerDescription>
            </div>
          </div>
        </DrawerHeader>

        <ResizablePanelGroup direction="horizontal" className="flex-1">
          {/* Left Panel - Navigation + Content */}
          <ResizablePanel defaultSize={60} minSize={30}>
            <Tabs defaultValue="details" className="flex flex-col h-full">
              <TabsList className="w-full justify-start rounded-none border-b bg-muted">
                {tabs.map((tab) => {
                  const Icon = tab.icon;
                  return (
                    <TabsTrigger
                      key={tab.value}
                      value={tab.value}
                      className="gap-2"
                    >
                      <Icon className="h-4 w-4" />
                      {tab.label}
                      {tab.count !== undefined && (
                        <Badge variant="secondary">{tab.count}</Badge>
                      )}
                    </TabsTrigger>
                  );
                })}
              </TabsList>

              {tabs.map((tab) => (
                <TabsContent
                  key={tab.value}
                  value={tab.value}
                  className="flex-1 m-0"
                >
                  <ScrollArea className="h-full">
                    <div className="p-6">{tab.content}</div>
                  </ScrollArea>
                </TabsContent>
              ))}
            </Tabs>
          </ResizablePanel>

          <ResizableHandle withHandle />

          {/* Right Panel - Static Info */}
          <ResizablePanel defaultSize={40} minSize={25}>
            <VulnerabilityInfoColumn vulnerability={vulnerability} />
          </ResizablePanel>
        </ResizablePanelGroup>
      </DrawerContent>
    </Drawer>
  );
}
